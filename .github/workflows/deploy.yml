name: "üöÄ - Deploy to docs.magento-opensource.com"

on:
  push:
    branches:
      - main

jobs:
  sync-docs:
    name: "üìÑ - Sync documentation content"
    runs-on: ubuntu-latest

    steps:
      - name: "üîî - Trigger docs sync webhook"
        run: |
          echo "üìÅ Triggering docs sync..."

          # Generate the signature GitHub would use
          PAYLOAD='{"ref":"refs/heads/main"}'
          SIGNATURE="sha256=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "${{ secrets.WEBHOOK_SECRET }}" | cut -d' ' -f2)"

          # Call the webhook
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: push" \
            -H "X-Hub-Signature-256: $SIGNATURE" \
            -d "$PAYLOAD" \
            "https://docs.magento-opensource.com/webhook/sync-docs")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response: $BODY"
          echo "HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ Documentation sync triggered successfully!"
          else
            echo "‚ùå Documentation sync failed!"
            exit 1
          fi
